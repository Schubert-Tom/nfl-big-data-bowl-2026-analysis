<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kinematic Based Coverage and Risk Analysis</title>

  <!-- Plotly (loaded once). If you want fully offline, download this file and serve locally. -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    :root { color-scheme: dark; }

    body{
      background:#111;
      color:#eee;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:24px;
    }

    header{display:grid;gap:12px;margin-bottom:16px;}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    input[type="search"]{
      padding:10px 12px;min-width:260px;border-radius:10px;border:1px solid #9996;
      background:transparent;color:inherit;
    }
    button,select,label{
      border-radius:10px;border:1px solid #9996;padding:10px 12px;background:transparent;color:inherit;
    }
    label{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;}
    .meta{opacity:.8;font-size:.95rem;}
    .desc{
      border:1px solid #9996;border-radius:14px;padding:12px 14px;
      font-size:1.02rem;line-height:1.35;opacity:.95;
    }

    .layout{display:grid;gap:14px;grid-template-columns:420px 1fr;align-items:start;}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;}
    .card{
      border:1px solid #9996;border-radius:14px;padding:12px;cursor:pointer;user-select:none;
    }
    .card:hover{filter:brightness(1.03);}
    .card.selected{outline:2px solid #6aa6ff66;}
    .title{font-weight:650;margin:0;}

    .viewer{
      border:1px solid #9996;border-radius:14px;padding:12px;
      position:sticky;top:16px;
    }
    .viewerHeader{
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px;
    }
    .viewerHeader .name{font-weight:650;}
    .viewerHeader .hint{opacity:.75;font-size:.95rem;}

    #plot{
      width:100%;
      height:1000px;
      border-radius:10px;
      background:#00000008;
    }

    .err{border:1px solid #c33;padding:12px;border-radius:12px;}
    .hint{opacity:.85;}
    .hidden{display:none;}

    /* Responsive */
    @media (max-width: 980px){
      body{margin:14px;}
      .layout{grid-template-columns:1fr;}
      .viewer{position:static;top:auto;}
      input[type="search"]{min-width:180px;flex:1;}
    }
    @media (max-width: 560px){
      .grid{grid-template-columns:1fr;}
    }

    /* Plot-only mode (opened in a new tab via ?plot=play_001.json) */
    .plot-only header,
    .plot-only #gridWrap { display:none !important; }
    .plot-only .layout { grid-template-columns:1fr; }
    .plot-only #viewer { display:block !important; border:0; padding:0; }
    .plot-only #plot { height:100vh !important; border-radius:0; }
  </style>
</head>

<body>
  <header>
    <h1 style="margin:0;">Plotly Gallery</h1>

    <div class="row">
      <input id="q" type="search" placeholder="Search plays‚Ä¶" />

      <label title="Show an in-page preview (desktop)">
        <input id="preview" type="checkbox" checked />
        Preview
      </label>

      <label title="Preview height (desktop)">
        Height
        <select id="height">
          <option value="1000" selected>1000px</option>
          <option value="1200">1200px</option>
          <option value="900">900px</option>
          <option value="800">800px</option>
          <option value="720">720px</option>
          <option value="600">600px</option>
          <option value="480">480px</option>
          <option value="360">360px</option>
        </select>
      </label>

      <button id="reload" type="button">Reload list</button>
      <span id="status" class="meta"></span>
    </div>

    <div id="error" class="err hidden"></div>

    <div class="desc">
      <h2>üèà Kinematics-Based Coverage Gallery</h2>
      <p>
        This gallery renders <strong>Plotly JSON</strong> figures from <code>figures/*.json</code> using a single Plotly runtime
        (smoother than iframes).
      </p>
      <ul>
        <li><strong>Desktop:</strong> click to preview, double-click to open plot-only tab.</li>
        <li><strong>Mobile:</strong> preview is disabled; tapping a play opens a new tab.</li>
      </ul>

      <hr />

      <div class="hint">
        Recommended: create <code>figures/manifest.json</code> with a JSON array of filenames, e.g.
        <code>["play_001.json","play_002.json"]</code> to avoid GitHub API rate limits.
      </div>
    </div>
  </header>

  <main class="layout">
    <section id="gridWrap">
      <div id="grid" class="grid"></div>
    </section>

    <section id="viewer" class="viewer hidden">
      <div class="viewerHeader">
        <div class="name" id="viewerName"></div>
        <div class="hint" id="viewerHint"></div>
      </div>
      <div id="plot"></div>
    </section>
  </main>

  <script>
    const els = {
      q: document.getElementById("q"),
      preview: document.getElementById("preview"),
      height: document.getElementById("height"),
      reload: document.getElementById("reload"),
      status: document.getElementById("status"),
      error: document.getElementById("error"),
      grid: document.getElementById("grid"),
      viewer: document.getElementById("viewer"),
      viewerName: document.getElementById("viewerName"),
      viewerHint: document.getElementById("viewerHint"),
      plot: document.getElementById("plot"),
    };

    const CONFIG = {
      manifestPath: "figures/manifest.json",
      githubApiFallback: true, // set false to never call GitHub API
      mobileMaxWidth: 980
    };

    let allFiles = [];
    let selectedFile = null;

    const params = new URLSearchParams(location.search);
    const plotParam = params.get("plot"); // e.g. play_001.json
    if (plotParam) document.documentElement.classList.add("plot-only");

    function isMobile() {
      return window.matchMedia(`(max-width: ${CONFIG.mobileMaxWidth}px)`).matches;
    }

    function sortFiles(files) {
      return files.slice().sort((a,b) => a.localeCompare(b, undefined, { numeric:true, sensitivity:"base" }));
    }

    function nameFromFile(filename) {
      return filename.replace(/\.json$/i, "");
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function showError(msg) {
      els.error.classList.remove("hidden");
      els.error.innerHTML = `
        <div><strong>Error</strong></div>
        <div style="margin-top:6px;">${escapeHtml(msg)}</div>
        <div class="hint" style="margin-top:10px;">
          If listing fails due to GitHub API limits, add <code>${escapeHtml(CONFIG.manifestPath)}</code>
          containing a JSON array of your <code>.json</code> files.
        </div>
      `;
    }

    function hideError() {
      els.error.classList.add("hidden");
      els.error.innerHTML = "";
    }

    async function fetchManifestList() {
      const r = await fetch(CONFIG.manifestPath, { cache: "no-store" });
      if (!r.ok) return null;
      const j = await r.json();
      if (!Array.isArray(j)) return null;
      return sortFiles(
        j.filter(x => typeof x === "string").filter(x => x.toLowerCase().endsWith(".json"))
      );
    }

    function inferOwnerRepo() {
      // Works for <owner>.github.io/<repo>/...
      const host = location.hostname;
      if (!host.endsWith("github.io")) return { owner: null, repo: null };
      const owner = host.split(".")[0] || "";
      const parts = location.pathname.split("/").filter(Boolean);
      const repo = parts.length ? parts[0] : `${owner}.github.io`;
      return { owner, repo };
    }

    function explainRateLimit(r) {
      const remaining = r.headers.get("x-ratelimit-remaining");
      const reset = r.headers.get("x-ratelimit-reset");
      if (r.status === 403 && remaining === "0" && reset) {
        const when = new Date(Number(reset) * 1000).toLocaleString();
        return `GitHub API rate limit hit (403). Try again after ${when} or add figures/manifest.json.`;
      }
      return null;
    }

    async function fetchFiguresListFromGitHub(owner, repo) {
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/figures`;
      const r = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
      if (!r.ok) throw new Error(explainRateLimit(r) || `GitHub contents API failed (${r.status}).`);

      const j = await r.json();
      const files = (Array.isArray(j) ? j : [])
        .filter(x => x && x.type === "file" && typeof x.name === "string" && x.name.toLowerCase().endsWith(".json"))
        .map(x => x.name);

      return sortFiles(files);
    }

    function updateViewerVisibility() {
      const showPreview = els.preview.checked && !isMobile() && !plotParam;

      if (!showPreview || !selectedFile) {
        els.viewer.classList.add("hidden");
        return;
      }
      els.viewer.classList.remove("hidden");

      const h = Number(els.height.value) || 1000;
      els.plot.style.height = `${h}px`;
      // Let Plotly resize into the new height
      if (window.Plotly) window.Plotly.Plots.resize(els.plot);
    }

    function renderList() {
      const query = els.q.value.trim().toLowerCase();
      const files = allFiles.filter(name => name.toLowerCase().includes(query));

      els.status.textContent = `${files.length} / ${allFiles.length} plays`;

      els.grid.innerHTML = files.map(name => {
        const title = nameFromFile(name);
        const selected = (name === selectedFile) ? "selected" : "";
        return `
          <div class="card ${selected}" data-file="${escapeHtml(name)}" role="button" tabindex="0">
            <p class="title">${escapeHtml(title)}</p>
          </div>
        `;
      }).join("");

      updateViewerVisibility();
    }

    async function renderPlotFromJson(filename) {
      if (!window.Plotly) throw new Error("Plotly failed to load (CDN blocked/offline).");

      const href = `figures/${encodeURIComponent(filename)}`;
      els.viewerName.textContent = nameFromFile(filename);
      els.viewerHint.textContent = href;

      const r = await fetch(href, { cache: "no-store" });
      if (!r.ok) throw new Error(`Failed to load ${href} (${r.status})`);

      const fig = await r.json();

      // Support a few common JSON shapes:
      // 1) {data, layout, config}
      // 2) full Plotly schema exports that still have data/layout
      const data = fig.data || [];
      const layout = fig.layout || {};
      const config = Object.assign({ responsive: true, displaylogo: false }, (fig.config || {}));

      await Plotly.react(els.plot, data, layout, config);
    }

    async function selectFile(filename, {openInNewTab=false} = {}) {
      selectedFile = filename;

      if (openInNewTab) {
        window.open(`./?plot=${encodeURIComponent(filename)}`, "_blank", "noopener");
        return;
      }

      renderList();
      updateViewerVisibility();

      const shouldPreview = els.preview.checked && !isMobile();

      if (plotParam || shouldPreview) {
        els.viewer.classList.remove("hidden");
        await renderPlotFromJson(filename);
        updateViewerVisibility();
      }
    }

    async function loadList() {
      hideError();
      els.status.textContent = "Loading‚Ä¶";

      // Mobile behavior: disable preview
      if (isMobile() && !plotParam) {
        els.preview.checked = false;
        els.preview.disabled = true;
      } else {
        els.preview.disabled = false;
      }

      try {
        const manifest = await fetchManifestList();
        if (manifest && manifest.length) {
          allFiles = manifest;
        } else if (CONFIG.githubApiFallback) {
          const { owner, repo } = inferOwnerRepo();
          if (!owner || !repo) {
            throw new Error("No manifest.json found and cannot infer GitHub owner/repo (custom domain?). Add figures/manifest.json.");
          }
          allFiles = await fetchFiguresListFromGitHub(owner, repo);
        } else {
          throw new Error("No manifest.json found. Create figures/manifest.json with your .json filenames.");
        }

        // Choose initial selection
        if (plotParam && allFiles.includes(plotParam)) {
          selectedFile = plotParam;
        } else {
          selectedFile = allFiles[0] || null;
        }

        renderList();

        if (!allFiles.length) {
          showError("No .json files found in /figures (or manifest is empty).");
          els.status.textContent = "0 plays";
          return;
        }

        // Plot-only mode: render immediately
        if (plotParam && selectedFile) {
          els.preview.checked = true; // irrelevant in plot-only mode, but harmless
          els.viewer.classList.remove("hidden");
          await renderPlotFromJson(selectedFile);
        }
      } catch (e) {
        allFiles = [];
        selectedFile = null;
        els.grid.innerHTML = "";
        els.status.textContent = "";
        els.viewer.classList.add("hidden");
        showError(e?.message || String(e));
      }
    }

    // UI hooks
    els.q.addEventListener("input", renderList);
    els.preview.addEventListener("change", async () => {
      updateViewerVisibility();
      if (els.preview.checked && selectedFile && !isMobile()) {
        try { await renderPlotFromJson(selectedFile); } catch (e) { showError(e?.message || String(e)); }
      }
    });
    els.height.addEventListener("change", updateViewerVisibility);
    els.reload.addEventListener("click", loadList);

    // Click-to-select (event delegation)
    els.grid.addEventListener("click", async (ev) => {
      const card = ev.target.closest(".card");
      if (!card) return;
      const file = card.getAttribute("data-file");
      if (!file) return;

      // Mobile: open new tab immediately, no preview
      if (isMobile()) {
        await selectFile(file, { openInNewTab: true });
        return;
      }

      try {
        await selectFile(file, { openInNewTab: false });
      } catch (e) {
        showError(e?.message || String(e));
      }
    });

    // Double-click (desktop): open plot-only view in new tab
    els.grid.addEventListener("dblclick", (ev) => {
      const card = ev.target.closest(".card");
      if (!card) return;
      const file = card.getAttribute("data-file");
      if (!file) return;
      window.open(`./?plot=${encodeURIComponent(file)}`, "_blank", "noopener");
    });

    // Keyboard accessibility
    els.grid.addEventListener("keydown", async (ev) => {
      if (ev.key !== "Enter" && ev.key !== " ") return;
      const card = ev.target.closest(".card");
      if (!card) return;
      ev.preventDefault();
      const file = card.getAttribute("data-file");
      if (!file) return;

      if (isMobile()) {
        await selectFile(file, { openInNewTab: true });
        return;
      }

      try {
        await selectFile(file, { openInNewTab: false });
      } catch (e) {
        showError(e?.message || String(e));
      }
    });

    // Handle resize: mobile/desktop toggle + plot resize
    window.addEventListener("resize", () => {
      if (!plotParam) {
        if (isMobile()) {
          els.preview.checked = false;
          els.preview.disabled = true;
        } else {
          els.preview.disabled = false;
        }
        updateViewerVisibility();
      }
      if (window.Plotly && !els.viewer.classList.contains("hidden")) {
        window.Plotly.Plots.resize(els.plot);
      }
    });

    loadList();
  </script>
</body>
</html>
